# socket
- 参考资料：
  - https://www.zhihu.com/question/31965911
  - https://www.jianshu.com/p/a3e06ec1a3a0
### 1 概述
- socket.io 是一个基于WebSocket的C-S（client-server）实时通信库，底层是基于engine.io。
- engine.io 使用WebSocket和xhr-poling封装了一套自己的协议，在不支持Websocket的低版本浏览器中使用长轮询来代替。
- socket.io 在engine.io的基础上增加了namespace，room，自动重连等特性
### 2 WebSocket 协议
- Http协议是“请求-响应”的模式，并不能实现双向通信。起初这种模式也能很好的满足web应用程序。
- 为了能实现双向通信机制，就只能利用Http轮询的方式，由此产生了“段轮询”和“长轮询”
  - 短轮询：通过客户端定期轮询来询问服务端是否有新的信息产生。
    - 缺点：轮询时间间隔大了则信息不够实时，轮询间隔小了又会消耗过多的流量，增加服务器的负担。
  - 长轮询：长轮询是对短轮询的优化，需要服务端做相应的修改来支持。客户端会向服务器发送请求时，如果此时服务端没有新的信息产生，并不立刻返回，而是Hang住一段时间等新的信息或者超时再返回，客户端收到服务器的应答后继续轮询
    - 长轮询相对于短轮询可以减少大量无用的请求，并且客户端接收新消息也会实时不少
    - 缺点：  
       1）每次请求都需要带上HTTP请求头  
       2）长轮询连接结束之后，服务器积累的新消息要等到下次客户端连接时才能传递
- 不管是长轮询还是短轮询，都是基于HTTP请求的，HTTP请求可能包含比较长的头部信息，其实正则有效的数据只占了一小部分，而且每次请求数据都要发送很长的信息，会浪费很多的带宽等资源。HTTP的局限性：
  - 请求只能从客户端开始，客户端不可以接收除响应以外的指令
  - 首部未经压缩就发送，首部信息越多延迟就越大
- 更好的实现方式：只用一个TCP连接来实现客户端和服务端的双向通信
- WebSocket是基于TCP的一个独立的协议，是在TCP连接上进行全双工通信的协议，能在实现实时通信的同时，很好的节省服务器资源和带宽。
- WebSocket受网络限制比较大，需要处理重连，比如用户仅电梯或者打电话断网了，就需要重连。WebSocket在设计到比较复杂的业务时比较容易出问题。
### 3 Websocket和HTTP的区别
- 相同点：
  - 都是基于TCP的可靠性传输协议
  - 都是应用层协议
- 不同点
  - websocket中，浏览器和服务器只需要完成一次握手，就能建立持久性的连接，并进行双向数据传输。（WebSocket在建立握手时，数据是通过HTTP传输的，但建立之后，是不需要HTTP协议的，这也是HTTP与WebSocket唯一关联的地方）
  - 建立WebSocket之后，服务器可以主动向浏览器发送数据，而且信息中不必再有head的部分信息，与http长连接相比，这种方式不仅能降低服务器的压力，而且信息当中也减少了部分多于的信息，节省了带宽。
  - http是单向的，服务器和浏览器进行通信，必须由浏览器发起请求，然后由服务器返回结果（http分为长连接和短连接，短连接是每次请求都要三次握手才能发送自己的信息，即每一个request对应一个response，长连接是在一定期限内保持TCP连接不断开）

### 4.源码分析
- 建立连接后，每个客户端会被自动加入到一个默认的命名空间 /，在每个命名空间中，socket会被加入到两个名为None和sid的房间。
  - None：用于广播
  - sid：用于单播
- 除了默认的房间之外，可以使用roomid自定义房间。
- socket.io 是基于engine.io的，支持WebSocket和long polling。
  - 如果是long polling，会定时发送GET,POST请求，当没有数据时，GET请求会hang住，直到有新数据或是超时
  - 如果upgrade到了WebSocket连接，则探测成功后会定期ping/Pong来保持连接，使用WebSocket实现全双工通信。
#### 建立连接
- 客户端发送一个polling请求来建立连接

